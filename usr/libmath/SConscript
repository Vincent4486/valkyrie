# SPDX-License-Identifier: BSD-3-Clause

import os

from SCons.Script import Dir
from scripts.scons.utility import GlobRecursive

Import('usermode_env')
Import('musl_include')
Import('musl_lib')

env = usermode_env.Clone()

# Get source directory
src_dir = Dir('#usr/libmath').abspath

env.Append(
    # Absolute code with explicit relocations that we'll patch at load time
    CCFLAGS=['-fno-PIC', '-fno-asynchronous-unwind-tables'],
    CFLAGS=['-fno-PIC'],
    CXXFLAGS=['-fno-PIC'],
    LINKFLAGS=[
        '-shared',
        '-Wl,-shared',
        '-Wl,-T', os.path.join(src_dir, 'linker.ld'),
        '-Wl,-Map=' + env.File('libmath.map').path,
        '-Wl,--as-needed',
        '-Wl,-soname,libmath.so',
        '-Wl,-Bsymbolic-functions',  # Resolve internal references locally
    ],
    CPATH=[src_dir],
    CPPPATH=[src_dir],
    # Include source directory for assembly files (nasm -I flag for include paths)
    ASFLAGS=['-I', src_dir + '/', '-f', 'elf']
)

# Glob files directly from the source directory using os.walk
sources = []
for root, dirs, files in os.walk(src_dir):
    for file in files:
        full_path = os.path.join(root, file)
        if file.endswith(('.c', '.cpp', '.S')):
            # Make path relative to src_dir so SCons puts objects in build dir
            rel_path = os.path.relpath(full_path, src_dir)
            sources.append(rel_path)


objects = env.SharedObject(sources)

# Build shared library
libmath_so = env.SharedLibrary('libmath', objects)

# Export as libmath_module for kernel build system detection
libmath_module = libmath_so
Export('libmath_module')

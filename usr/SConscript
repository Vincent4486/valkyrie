# SPDX-License-Identifier: BSD-3-Clause
"""
Usermode build configuration.

Sets up the usermode environment with musl libc support and builds
all userspace libraries and applications.
"""

import os

from SCons.Environment import Environment
from SCons.Script import Export

from scripts.scons.arch import get_arch_config

Import('TARGET_ENVIRONMENT')
TARGET_ENVIRONMENT: Environment


# =============================================================================
# Usermode Environment Setup
# =============================================================================

arch = TARGET_ENVIRONMENT['arch']
arch_config = get_arch_config(arch)
target_triple = arch_config['target_triple']

# Build sysroot path from toolchain prefix and target
toolchain_prefix = str(TARGET_ENVIRONMENT['TOOLCHAIN_PREFIX'])
sysroot = os.path.join(toolchain_prefix, target_triple, 'sysroot', 'usr')

musl_include = os.path.join(sysroot, 'include')
musl_lib = os.path.join(sysroot, 'lib')

# Create usermode environment with musl support
usermode_env = TARGET_ENVIRONMENT.Clone()
usermode_env.Append(
    CPPDEFINES=['_POSIX_C_SOURCE=200809L'],  # POSIX.1-2008
)

# Architecture-specific flags for userland
usermode_env.Append(
    ASFLAGS=arch_config.get('asflags', []),
    CCFLAGS=arch_config.get('ccflags', []),
    LINKFLAGS=arch_config.get('linkflags', []),
)

# Configure shared library naming
usermode_env['SHLIBPREFIX'] = 'lib'
usermode_env['SHLIBSUFFIX'] = '.so'

Export('usermode_env')
Export('musl_include')
Export('musl_lib')


# =============================================================================
# Build Sub-projects
# =============================================================================

SConscript('libmath/SConscript', variant_dir='libmath_build', duplicate=0)
SConscript('sh/SConscript', variant_dir='sh_build', duplicate=0)


# =============================================================================
# Export Build Products
# =============================================================================

Import('libmath_module')
Import('sh_module')

user_libraries = [libmath_module]
user_applications = [sh_module]

Export('user_libraries')
Export('user_applications')
